<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Server-sent events demo</title>
  <style>
    * {
      font: 14px D2Coding;
    }
  </style>
</head>

<body>
  <div>
    <input type="text" id="userid" value="nam" placeholder="your id" />
    <button id="connectBtn">Connect</button>
    <button id="closeBtn" style="display: none;">Close the connection</button>
  </div>

  <ul></ul>

  <script type="text/javascript">
    const connectBtn = document.querySelector('button#connectBtn');
    const closeBtn = document.querySelector('button#closeBtn');
    const eventList = document.querySelector('ul');

    let evtSource;

    closeBtn.onclick = function () {
      console.log('Connection closed');
      evtSource.close();
      
      connectBtn.style.display = '';
      closeBtn.style.display = 'none';
    };
    connectBtn.onclick = function () {
      // https://developer.mozilla.org/ko/docs/Web/API/EventSource
      const userid = document.querySelector('#userid').value;
      evtSource = new EventSource('http://localhost:8080/noti/sse/' + userid);

      connectBtn.style.display = 'none';
      closeBtn.style.display = '';

      console.log('Connection connected');
      console.log('withCredentials', evtSource.withCredentials);
      console.log('readyState', evtSource.readyState); // CONNECTING (0), OPEN (1), or CLOSED (2).
      console.log('url', evtSource.url);
      console.log(evtSource);

      evtSource.onopen = function () {
        console.log('Connection to server opened.');
      };

      evtSource.onmessage = function (e) {
        console.log('e', e);
        console.log('e.event', e.event);
        console.log('e.data', e.data);
        console.log('e.id', e.id);
        console.log('e.retry', e.retry);
        var newElement = document.createElement('li');
        newElement.textContent = 'message: ' + e.data;
        eventList.appendChild(newElement);
      };

      evtSource.onerror = function () {
        console.log('EventSource failed.');
      };

      evtSource.addEventListener(
        'Notify',
        function (e) {
          console.log('Notify', e);
          console.log('type', e.type);
          console.log('lastEventId', e.lastEventId);
          console.log('timeStamp', e.timeStamp);
          console.log('data', JSON.parse(e.data));

          var obj = JSON.parse(e.data);
          var newElement = document.createElement('li');
          newElement.innerHTML = `Notify: [${obj.message}] at ` + new Date(obj.date);
          eventList.appendChild(newElement);
        },
        false
      );

      evtSource.addEventListener(
        'ping',
        function (e) {
          var newElement = document.createElement('li');
          var obj = JSON.parse(e.data);
          newElement.innerHTML = 'ping at ' + obj.time;
          eventList.appendChild(newElement);
        },
        false
      );
    };

  </script>
</body>

</html>